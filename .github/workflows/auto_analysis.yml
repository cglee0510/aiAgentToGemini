# .github/workflows/auto_analysis.yml
name: Auto News Analysis

on:
  push:
    paths:
      - 'economic_news_report_*.txt'  # ë‰´ìŠ¤ ë¦¬í¬íŠ¸ íŒŒì¼ì´ í‘¸ì‹œë  ë•Œ íŠ¸ë¦¬ê±°
    branches:
      - main
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ë„ ê°€ëŠ¥

jobs:
  analyze_news:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # ì „ì²´ íˆìŠ¤í† ë¦¬ ê°€ì ¸ì˜¤ê¸°
        
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        pip install google-generativeai requests python-dateutil
        
    - name: Get latest news report file
      id: get_file
      run: |
        # ê°€ì¥ ìµœê·¼ì— ì¶”ê°€ëœ ë‰´ìŠ¤ ë¦¬í¬íŠ¸ íŒŒì¼ ì°¾ê¸°
        LATEST_FILE=$(ls -t economic_news_report_*.txt 2>/dev/null | head -1)
        if [ -z "$LATEST_FILE" ]; then
          echo "No new news report found"
          echo "skip=true" >> $GITHUB_OUTPUT
        else
          echo "Found new file: $LATEST_FILE"
          echo "filename=$LATEST_FILE" >> $GITHUB_OUTPUT
          echo "skip=false" >> $GITHUB_OUTPUT
        fi
        
    - name: Analyze news with Gemini AI
      if: steps.get_file.outputs.skip == 'false'
      env:
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      run: |
        python .github/Scripts/analyze_news.py "${{ steps.get_file.outputs.filename }}"
        
    - name: Commit and push analysis (Conflict Resolution)
      if: steps.get_file.outputs.skip == 'false'
      run: |
        echo "=== Git ì»¤ë°‹ ë° í‘¸ì‹œ (ì¶©ëŒ í•´ê²° í¬í•¨) ==="
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # ìµœëŒ€ 3ë²ˆ ì¬ì‹œë„
        for i in {1..3}; do
          echo "--- ì‹œë„ $i/3 ---"
          
          # ì›ê²© ë³€ê²½ì‚¬í•­ ë™ê¸°í™”
          echo "ì›ê²© ë³€ê²½ì‚¬í•­ ê°€ì ¸ì˜¤ê¸°..."
          git fetch origin main
          git pull origin main --no-edit || echo "Pull ì‹œë„ ì™„ë£Œ"
          
          # ë¶„ì„ íŒŒì¼ ì¶”ê°€
          echo "ë¶„ì„ íŒŒì¼ ì¶”ê°€..."
          git add analysis_*.md 2>/dev/null || echo "ì¶”ê°€í•  ë¶„ì„ íŒŒì¼ ì—†ìŒ"
          
          if git diff --staged --quiet; then
            echo "ë³€ê²½ì‚¬í•­ ì—†ìŒ, ì¢…ë£Œ"
            break
          else
            echo "ì»¤ë°‹ ìƒì„±..."
            git commit -m "ğŸ¤– ìë™ ë¶„ì„: ${{ steps.get_file.outputs.filename }}"
            
            echo "Push ì‹œë„..."
            if git push origin main; then
              echo "âœ… Push ì„±ê³µ!"
              break
            else
              echo "âŒ Push ì‹¤íŒ¨, ì¬ì‹œë„ ì¤€ë¹„..."
              sleep 5
            fi
          fi
          
          if [ $i -eq 3 ]; then
            echo "âŒ 3ë²ˆ ì‹œë„ í›„ì—ë„ ì‹¤íŒ¨"
            exit 1
          fi
        done